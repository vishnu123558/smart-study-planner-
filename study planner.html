<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Study Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --muted: #6b7280;
            --text: #f9fafb;
            --primary: #6366f1;
            --primary-600: #4f46e5;
            --accent: #22d3ee;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #1f2937;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
            background: radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.15), transparent 60%),
                        radial-gradient(1000px 700px at 120% 10%, rgba(34,211,238,.12), transparent 50%),
                        var(--bg);
            color: var(--text);
        }
        .app {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
            border: 1px solid var(--border);
            border-radius: 16px;
            backdrop-filter: blur(4px);
            box-shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        .sidebar { padding: 16px; }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        .title { font-size: 18px; font-weight: 700; }
        .muted { color: var(--muted); }
        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border);
            background: #0b1220; color: var(--text); cursor: pointer;
            transition: all .2s ease; font-weight: 600;
        }
        .btn:hover { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,.15) inset; }
        .btn-primary { background: linear-gradient(180deg, var(--primary), var(--primary-600)); border-color: transparent; }
        .btn-danger { background: linear-gradient(180deg, var(--danger), #b91c1c); border-color: transparent; }
        .btn-ghost { background: transparent; }
        .stack { display: flex; flex-direction: column; gap: 12px; }
        .row { display: flex; align-items: center; gap: 10px; }
        .chip { padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); font-size: 12px; }
        .progress {
            height: 10px; border-radius: 999px; background: #0b1220; border: 1px solid var(--border);
            overflow: hidden;
        }
        .progress > span { display: block; height: 100%; background: linear-gradient(90deg, var(--success), var(--accent)); width: 0%; transition: width .4s ease; }
        .list { display: grid; gap: 10px; }
        .card {
            padding: 12px 12px; border-radius: 12px; border: 1px solid var(--border);
            background: rgba(17,24,39,.6);
            display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
        }
        .card h4 { margin: 0 0 4px; font-size: 14px; }
        .card p { margin: 0; color: var(--muted); font-size: 12px; }
        .badge { font-size: 11px; padding: 4px 8px; border-radius: 8px; background: #0b1220; border: 1px solid var(--border); color: var(--muted); }
        .calendar {
            padding: 10px 16px 16px; display: grid; gap: 10px;
        }
        .calendar .cal-header { display: flex; align-items: center; justify-content: space-between; }
        .calendar .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar .dow { text-align: center; color: var(--muted); font-weight: 600; font-size: 12px; padding: 6px 0; }
        .day {
            border: 1px solid var(--border); border-radius: 10px; padding: 8px; min-height: 84px; background: #0b1220;
            display: grid; grid-template-rows: auto 1fr; gap: 6px;
        }
        .day header { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: var(--muted); }
        .dotbar { display: flex; gap: 4px; flex-wrap: wrap; }
        .dot { width: 6px; height: 6px; border-radius: 999px; background: var(--primary); opacity: .8; }
        .day.today { outline: 2px solid var(--accent); }
        .tasks-panel { padding: 10px 16px 16px; display: grid; grid-template-columns: 1fr 380px; gap: 16px; }
        .tasks-panel .tasks { display: grid; gap: 10px; }
        .empty { border: 1px dashed var(--border); padding: 18px; border-radius: 12px; color: var(--muted); text-align: center; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
        input, select, textarea {
            width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
            background: #0b1220; color: var(--text);
        }
        textarea { resize: vertical; min-height: 78px; }
        .toolbar { display: flex; gap: 8px; align-items: center; }
        .kanban { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .kanban .column { border: 1px solid var(--border); border-radius: 12px; padding: 10px; background: #0b1220; }
        .kanban .column h4 { margin: 0 0 8px; }
        .footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .notice { color: var(--muted); font-size: 12px; }
        @media (max-width: 1100px) {
            .app { grid-template-columns: 1fr; }
            .tasks-panel { grid-template-columns: 1fr; }
            .kanban { grid-template-columns: 1fr; }
        }
    </style>
    <link rel="manifest" href="data:application/manifest+json,{\"name\":\"Study Planner\",\"short_name\":\"Study\",\"display\":\"standalone\"}">
</head>
<body>
    <div class="app">
        <aside class="panel sidebar" id="sidebar">
            <div class="header">
                <div>
                    <div class="title">Study Planner</div>
                    <div class="muted" id="todayLabel"></div>
                </div>
                <button class="btn btn-primary" id="addGoalBtn">+ Add Goal</button>
            </div>
            <div class="stack" style="padding: 12px;">
                <div class="row" style="justify-content: space-between;">
                    <span class="chip" id="statsTasks">0 tasks</span>
                    <span class="chip" id="statsCompleted">0 completed</span>
                    <span class="chip" id="statsHours">0h planned</span>
                </div>
                <div>
                    <div class="row" style="justify-content: space-between; margin-bottom: 6px;">
                        <strong>Overall Progress</strong>
                        <span class="muted" id="progressLabel">0%</span>
                    </div>
                    <div class="progress"><span id="progressBar"></span></div>
                </div>
                <div class="panel" style="padding: 12px;">
                    <div class="row" style="justify-content: space-between; align-items: center;">
                        <strong>Weekly Focus</strong>
                        <button class="btn btn-ghost" id="clearAll">Reset</button>
                    </div>
                    <canvas id="weeklyChart" height="130"></canvas>
                </div>
                <div class="panel" style="padding: 12px;">
                    <div class="row" style="justify-content: space-between; align-items: center;">
                        <strong>Notifications</strong>
                        <button class="btn" id="notifyBtn">Enable</button>
                    </div>
                    <div class="notice">Desktop reminders use the browser Notification API with an alert fallback.</div>
                </div>
                <div class="stack" id="goalsList"></div>
            </div>
        </aside>

        <main class="panel" id="main">
            <div class="calendar">
                <div class="cal-header">
                    <div class="row">
                        <button class="btn" id="prevMonth">◀</button>
                        <h3 id="monthLabel" style="margin: 0 8px;">Month</h3>
                        <button class="btn" id="nextMonth">▶</button>
                        <button class="btn" id="todayBtn">Today</button>
                    </div>
                    <div class="toolbar">
                        <select id="filterGoal"></select>
                        <select id="filterStatus">
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="done">Done</option>
                        </select>
                        <button class="btn btn-primary" id="addTaskBtn">+ Add Task</button>
                    </div>
                </div>
                <div class="grid" id="dows"></div>
                <div class="grid" id="calendarGrid"></div>
            </div>
            <div class="tasks-panel">
                <section class="panel" style="padding: 12px;">
                    <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong>Tasks on <span id="selectedDateLabel"></span></strong>
                        <div class="toolbar">
                            <button class="btn" id="sortByTime">Sort by Time</button>
                            <button class="btn" id="sortByPriority">Sort by Priority</button>
                        </div>
                    </div>
                    <div class="tasks" id="tasksList"></div>
                    <div class="empty" id="emptyTasks" style="display:none;">No tasks scheduled on this day.</div>
                </section>
                <section class="panel" style="padding: 12px;">
                    <div class="kanban">
                        <div class="column">
                            <h4>To Do</h4>
                            <div class="list" id="colTodo"></div>
                        </div>
                        <div class="column">
                            <h4>In Progress</h4>
                            <div class="list" id="colDoing"></div>
                        </div>
                        <div class="column">
                            <h4>Done</h4>
                            <div class="list" id="colDone"></div>
                        </div>
                    </div>
                </section>
            </div>
            <div class="footer">
                <div class="notice">Data is stored locally in your browser. Use Reset to clear.</div>
                <div class="row">
                    <button class="btn" id="exportBtn">Export</button>
                    <label class="btn" style="cursor: pointer;">
                        Import <input type="file" id="importInput" accept="application/json" style="display:none;">
                    </label>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="modal" style="position: fixed; inset: 0; display:none; align-items: center; justify-content: center; background: rgba(0,0,0,.5);">
        <div class="panel" style="width: 680px; max-width: calc(100% - 24px);">
            <div class="header">
                <div class="title" id="modalTitle">Add Item</div>
                <button class="btn" id="closeModal">✕</button>
            </div>
            <div style="padding: 14px;" id="modalBody"></div>
            <div class="footer">
                <div></div>
                <div class="row">
                    <button class="btn" id="cancelModal">Cancel</button>
                    <button class="btn btn-primary" id="saveModal">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ---------- UTILITIES ----------
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const formatDateKey = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
        };
        const parseDateKey = (key) => { const [y,m,d] = key.split('-').map(Number); return new Date(y, m-1, d); };
        const uuid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

        // ---------- DATA MODEL (localStorage) ----------
        const STORAGE_KEY = 'studyPlanner.v1';
        const defaultData = { goals: [], tasks: [], settings: { notifications: 'default' } };
        const loadData = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || structuredClone(defaultData); } catch { return structuredClone(defaultData); } };
        const saveData = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

        let state = loadData();

        // ---------- NOTIFICATIONS / REMINDERS ----------
        let reminderTimers = new Map();
        async function ensureNotificationPermission() {
            if (!('Notification' in window)) return 'unsupported';
            if (Notification.permission === 'granted') return 'granted';
            if (Notification.permission !== 'denied') {
                try { const p = await Notification.requestPermission(); return p; } catch { return 'denied'; }
            }
            return Notification.permission;
        }
        function scheduleReminder(task) {
            clearReminder(task.id);
            if (!task.remindAt) return;
            const when = new Date(task.remindAt).getTime();
            const delay = when - Date.now();
            if (delay <= 0) return; // past
            const timer = setTimeout(async () => {
                const title = `Reminder: ${task.title}`;
                const body = `${task.subject || ''} • ${new Date(task.when).toLocaleString()}`;
                const permission = await ensureNotificationPermission();
                if (permission === 'granted') {
                    new Notification(title, { body });
                } else {
                    alert(`${title}\n${body}`);
                }
            }, Math.min(delay, 2**31-1));
            reminderTimers.set(task.id, timer);
        }
        function clearReminder(id) {
            const t = reminderTimers.get(id);
            if (t) { clearTimeout(t); reminderTimers.delete(id); }
        }
        function rehydrateReminders() { state.tasks.forEach(scheduleReminder); }

        // ---------- STATE HELPERS ----------
        function addGoal(goal) { state.goals.push(goal); saveData(); render(); }
        function updateGoal(id, patch) { Object.assign(state.goals.find(g => g.id===id), patch); saveData(); render(); }
        function deleteGoal(id) { state.goals = state.goals.filter(g => g.id!==id); state.tasks = state.tasks.filter(t => t.goalId!==id); saveData(); render(); }

        function addTask(task) { state.tasks.push(task); saveData(); scheduleReminder(task); render(); }
        function updateTask(id, patch) { const t = state.tasks.find(t => t.id===id); Object.assign(t, patch); saveData(); scheduleReminder(t); render(); }
        function deleteTask(id) { clearReminder(id); state.tasks = state.tasks.filter(t => t.id!==id); saveData(); render(); }

        // ---------- RENDER ----------
        const today = new Date();
        let currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        let selectedDate = formatDateKey(today);

        function renderSidebarStats() {
            const total = state.tasks.length;
            const completed = state.tasks.filter(t => t.status==='done').length;
            const hours = state.tasks.reduce((s,t)=> s + (Number(t.estimateHours)||0), 0);
            $('#statsTasks').textContent = `${total} tasks`;
            $('#statsCompleted').textContent = `${completed} completed`;
            $('#statsHours').textContent = `${hours}h planned`;
            const pct = total ? Math.round((completed/total)*100) : 0;
            $('#progressLabel').textContent = `${pct}%`;
            $('#progressBar').style.width = pct + '%';
            $('#todayLabel').textContent = new Date().toLocaleString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function renderGoals() {
            const wrap = $('#goalsList');
            wrap.innerHTML = '';
            if (state.goals.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.textContent = 'No goals yet. Click "Add Goal" to create one.';
                wrap.appendChild(empty);
                return;
            }
            state.goals.forEach(goal => {
                const total = state.tasks.filter(t=>t.goalId===goal.id).length;
                const done = state.tasks.filter(t=>t.goalId===goal.id && t.status==='done').length;
                const pct = total ? Math.round((done/total)*100) : 0;
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div>
                        <h4>${goal.title}</h4>
                        <p>${goal.subject||''}</p>
                        <div class="progress" style="margin-top:8px;"><span style="width:${pct}%"></span></div>
                        <div class="row" style="margin-top:6px;">
                            <span class="badge">${done}/${total} done</span>
                            <span class="badge">${goal.targetHours||0}h target</span>
                        </div>
                    </div>
                    <div class="stack" style="align-items:flex-end;">
                        <button class="btn" data-edit-goal="${goal.id}">Edit</button>
                        <button class="btn btn-danger" data-del-goal="${goal.id}">Delete</button>
                    </div>`;
                wrap.appendChild(card);
            });
        }

        function renderFilters() {
            const sel = $('#filterGoal');
            sel.innerHTML = '<option value="all">All Goals</option>' + state.goals.map(g=>`<option value="${g.id}">${g.title}</option>`).join('');
            $('#filterStatus').value = $('#filterStatus').value || 'all';
        }

        function renderCalendar() {
            const dows = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const dowsWrap = $('#dows'); dowsWrap.innerHTML = '';
            dows.forEach(d => { const div = document.createElement('div'); div.className='dow'; div.textContent=d; dowsWrap.appendChild(div); });

            const label = currentMonth.toLocaleString(undefined, { month: 'long', year: 'numeric' });
            $('#monthLabel').textContent = label;
            const grid = $('#calendarGrid'); grid.innerHTML = '';

            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const start = new Date(firstDay); start.setDate(start.getDate() - start.getDay());
            for (let i=0; i<42; i++) {
                const day = new Date(start); day.setDate(start.getDate() + i);
                const key = formatDateKey(day);
                const div = document.createElement('div');
                div.className = 'day' + (formatDateKey(day)===formatDateKey(new Date()) ? ' today' : '') + (day.getMonth()!==currentMonth.getMonth()? ' muted' : '');
                div.innerHTML = `
                    <header>
                        <span>${day.getDate()}</span>
                        <span class="badge">${state.tasks.filter(t=>t.when.startsWith(key)).length}</span>
                    </header>
                    <div class="dotbar">${state.tasks.filter(t=>t.when.startsWith(key)).slice(0,9).map(t=>`<span class="dot" title="${t.title}"></span>`).join('')}</div>
                `;
                div.addEventListener('click', ()=> { selectedDate = key; renderTasksForSelectedDay(); });
                grid.appendChild(div);
            }
        }

        function renderTasksForSelectedDay(sortBy) {
            $('#selectedDateLabel').textContent = new Date(selectedDate).toDateString();
            let tasks = state.tasks.filter(t => t.when.startsWith(selectedDate));
            const goalFilter = $('#filterGoal').value;
            const statusFilter = $('#filterStatus').value;
            if (goalFilter !== 'all') tasks = tasks.filter(t=>t.goalId===goalFilter);
            if (statusFilter !== 'all') tasks = tasks.filter(t=>t.status===statusFilter);
            if (sortBy === 'time') tasks.sort((a,b)=> a.when.localeCompare(b.when));
            if (sortBy === 'priority') tasks.sort((a,b)=> (b.priority||0)-(a.priority||0));

            const list = $('#tasksList'); list.innerHTML = '';
            $('#emptyTasks').style.display = tasks.length ? 'none' : 'block';
            tasks.forEach(t => {
                const goal = state.goals.find(g=>g.id===t.goalId);
                const item = document.createElement('div');
                item.className = 'card';
                item.innerHTML = `
                    <div>
                        <h4>${t.title} <span class="badge">${new Date(t.when).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></h4>
                        <p>${goal?goal.title:'No goal'} • ${t.subject||''}</p>
                        <div class="row" style="margin-top:6px;">
                            <span class="badge">${(t.estimateHours||0)}h</span>
                            <span class="badge">Priority ${t.priority||1}</span>
                            ${t.status==='done'?'<span class="badge" style="color:#10b981;">Done</span>':''}
                        </div>
                    </div>
                    <div class="stack" style="align-items:flex-end;">
                        <button class="btn" data-task-done="${t.id}">${t.status==='done'?'Undo':'Mark Done'}</button>
                        <button class="btn" data-task-edit="${t.id}">Edit</button>
                        <button class="btn btn-danger" data-task-del="${t.id}">Delete</button>
                    </div>`;
                list.appendChild(item);
            });

            // Kanban columns
            const todo = state.tasks.filter(t=>t.status==='todo');
            const doing = state.tasks.filter(t=>t.status==='doing');
            const done = state.tasks.filter(t=>t.status==='done');
            const renderCol = (el, arr) => { el.innerHTML = ''; arr.forEach(t=>{
                const d = document.createElement('div'); d.className='card';
                d.innerHTML = `<div><h4>${t.title}</h4><p>${new Date(t.when).toLocaleString()}</p></div>
                               <div class="row"><button class="btn" data-move="${t.id}" data-to="todo">To Do</button>
                               <button class="btn" data-move="${t.id}" data-to="doing">Doing</button>
                               <button class="btn" data-move="${t.id}" data-to="done">Done</button></div>`;
                el.appendChild(d);
            }); };
            renderCol($('#colTodo'), todo);
            renderCol($('#colDoing'), doing);
            renderCol($('#colDone'), done);

            renderWeeklyChart();
            renderSidebarStats();
            renderCalendar();
        }

        // ---------- CHARTS ----------
        let weeklyChart;
        function renderWeeklyChart() {
            const ctx = $('#weeklyChart');
            const now = new Date();
            const start = new Date(now); start.setDate(now.getDate() - 6);
            const labels = [];
            const hours = [];
            for (let i=0; i<7; i++) {
                const d = new Date(start); d.setDate(start.getDate() + i);
                const k = formatDateKey(d);
                labels.push(d.toLocaleDateString(undefined,{weekday:'short'}));
                const h = state.tasks.filter(t => t.when.startsWith(k) && t.status==='done')
                    .reduce((s,t)=> s + (Number(t.estimateHours)||0), 0);
                hours.push(h);
            }
            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Hours done', data: hours, backgroundColor: 'rgba(99,102,241,.7)' }] },
                options: { plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { ticks:{ color:'#94a3b8' } }, y: { ticks:{ color:'#94a3b8' } } } }
            });
        }

        // ---------- MODAL FORMS ----------
        const modal = $('#modal');
        const modalBody = $('#modalBody');
        const modalTitle = $('#modalTitle');
        let modalContext = { type: null, payload: null };
        function openModal(type, payload) {
            modalContext = { type, payload };
            modal.style.display = 'flex';
            if (type === 'goal') {
                modalTitle.textContent = payload? 'Edit Goal' : 'Add Goal';
                modalBody.innerHTML = `
                    <div class="form-grid">
                        <div>
                            <label>Title</label>
                            <input id="goalTitle" required value="${payload?.title||''}">
                        </div>
                        <div>
                            <label>Subject</label>
                            <input id="goalSubject" value="${payload?.subject||''}">
                        </div>
                        <div>
                            <label>Target Hours</label>
                            <input type="number" id="goalTarget" min="0" step="0.5" value="${payload?.targetHours||0}">
                        </div>
                        <div>
                            <label>Color</label>
                            <input id="goalColor" type="color" value="${payload?.color||'#6366f1'}">
                        </div>
                    </div>`;
            }
            if (type === 'task') {
                const goalsOptions = state.goals.map(g=>`<option value="${g.id}">${g.title}</option>`).join('');
                const p = payload||{};
                modalTitle.textContent = p.id? 'Edit Task' : 'Add Task';
                modalBody.innerHTML = `
                    <div class="form-grid">
                        <div>
                            <label>Title</label>
                            <input id="taskTitle" required value="${p.title||''}">
                        </div>
                        <div>
                            <label>Subject</label>
                            <input id="taskSubject" value="${p.subject||''}">
                        </div>
                        <div>
                            <label>Goal</label>
                            <select id="taskGoal">${goalsOptions}</select>
                        </div>
                        <div>
                            <label>Date & Time</label>
                            <input id="taskWhen" type="datetime-local" value="${p.when? p.when.slice(0,16): ''}">
                        </div>
                        <div>
                            <label>Estimate Hours</label>
                            <input id="taskHours" type="number" min="0" step="0.5" value="${p.estimateHours||1}">
                        </div>
                        <div>
                            <label>Priority (1-5)</label>
                            <input id="taskPriority" type="number" min="1" max="5" value="${p.priority||3}">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="taskStatus">
                                <option value="todo" ${p.status==='todo'?'selected':''}>To Do</option>
                                <option value="doing" ${p.status==='doing'?'selected':''}>In Progress</option>
                                <option value="done" ${p.status==='done'?'selected':''}>Done</option>
                            </select>
                        </div>
                        <div>
                            <label>Reminder</label>
                            <input id="taskRemind" type="datetime-local" value="${p.remindAt? p.remindAt.slice(0,16): ''}">
                        </div>
                        <div style="grid-column: 1 / -1;">
                            <label>Notes</label>
                            <textarea id="taskNotes">${p.notes||''}</textarea>
                        </div>
                    </div>`;
                $('#taskGoal').value = p.goalId || (state.goals[0]?.id || '');
            }
        }
        function closeModal() { modal.style.display = 'none'; modalBody.innerHTML = ''; }

        // ---------- EXPORT / IMPORT ----------
        function exportData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'study-planner.json';
            a.click();
        }
        function importData(file) {
            const reader = new FileReader();
            reader.onload = () => { try { state = JSON.parse(reader.result); saveData(); rehydrateReminders(); render(); } catch { alert('Invalid file'); } };
            reader.readAsText(file);
        }

        // ---------- EVENT WIRING ----------
        $('#addGoalBtn').addEventListener('click', () => openModal('goal'));
        $('#addTaskBtn').addEventListener('click', () => {
            if (state.goals.length === 0) { alert('Create a goal first.'); return; }
            openModal('task', { when: selectedDate + 'T09:00' });
        });
        $('#prevMonth').addEventListener('click', ()=> { currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); });
        $('#nextMonth').addEventListener('click', ()=> { currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); });
        $('#todayBtn').addEventListener('click', ()=> { currentMonth = new Date(today.getFullYear(), today.getMonth(), 1); selectedDate = formatDateKey(today); renderCalendar(); renderTasksForSelectedDay(); });
        $('#sortByTime').addEventListener('click', ()=> renderTasksForSelectedDay('time'));
        $('#sortByPriority').addEventListener('click', ()=> renderTasksForSelectedDay('priority'));
        $('#filterGoal').addEventListener('change', ()=> renderTasksForSelectedDay());
        $('#filterStatus').addEventListener('change', ()=> renderTasksForSelectedDay());
        $('#exportBtn').addEventListener('click', exportData);
        $('#importInput').addEventListener('change', (e)=> { if (e.target.files[0]) importData(e.target.files[0]); });
        $('#notifyBtn').addEventListener('click', ensureNotificationPermission);
        $('#clearAll').addEventListener('click', ()=> { if (confirm('Clear all local data?')) { state = structuredClone(defaultData); saveData(); render(); } });

        $('#closeModal').addEventListener('click', closeModal);
        $('#cancelModal').addEventListener('click', closeModal);
        $('#saveModal').addEventListener('click', ()=> {
            if (modalContext.type === 'goal') {
                const payload = modalContext.payload;
                const goal = {
                    id: payload?.id || uuid(),
                    title: $('#goalTitle').value.trim(),
                    subject: $('#goalSubject').value.trim(),
                    targetHours: Number($('#goalTarget').value)||0,
                    color: $('#goalColor').value
                };
                if (!goal.title) { alert('Title is required'); return; }
                if (payload) updateGoal(payload.id, goal); else addGoal(goal);
                closeModal();
                return;
            }
            if (modalContext.type === 'task') {
                const payload = modalContext.payload || {};
                const task = {
                    id: payload.id || uuid(),
                    title: $('#taskTitle').value.trim(),
                    subject: $('#taskSubject').value.trim(),
                    goalId: $('#taskGoal').value,
                    when: $('#taskWhen').value || (selectedDate + 'T09:00'),
                    estimateHours: Number($('#taskHours').value)||1,
                    priority: Number($('#taskPriority').value)||3,
                    status: $('#taskStatus').value,
                    remindAt: $('#taskRemind').value || '',
                    notes: $('#taskNotes').value
                };
                if (!task.title) { alert('Title is required'); return; }
                if (!task.goalId) { alert('Goal is required'); return; }
                if (payload.id) updateTask(payload.id, task); else addTask(task);
                closeModal();
                return;
            }
        });

        // Delegate click actions
        document.body.addEventListener('click', (e)=>{
            const editGoal = e.target.getAttribute('data-edit-goal');
            const delGoal = e.target.getAttribute('data-del-goal');
            const taskDone = e.target.getAttribute('data-task-done');
            const taskEdit = e.target.getAttribute('data-task-edit');
            const taskDel = e.target.getAttribute('data-task-del');
            const move = e.target.getAttribute('data-move');
            const to = e.target.getAttribute('data-to');
            if (editGoal) { const g = state.goals.find(x=>x.id===editGoal); openModal('goal', g); }
            if (delGoal) { if (confirm('Delete goal and its tasks?')) deleteGoal(delGoal); }
            if (taskDone) { const t = state.tasks.find(x=>x.id===taskDone); updateTask(taskDone, { status: t.status==='done'?'todo':'done' }); }
            if (taskEdit) { const t = state.tasks.find(x=>x.id===taskEdit); openModal('task', t); }
            if (taskDel) { if (confirm('Delete task?')) deleteTask(taskDel); }
            if (move && to) { updateTask(move, { status: to }); }
        });

        // ---------- INIT SAMPLE DATA IF EMPTY ----------
        function seedIfEmpty() {
            if (state.goals.length || state.tasks.length) return;
            const g1 = { id: uuid(), title: 'Math Exam Prep', subject: 'Calculus', targetHours: 10, color: '#22d3ee' };
            const g2 = { id: uuid(), title: 'History Essay', subject: 'WWII', targetHours: 6, color: '#f59e0b' };
            state.goals.push(g1, g2);
            const base = new Date();
            const dayKey = formatDateKey(base);
            state.tasks.push(
                { id: uuid(), title: 'Derivatives practice', subject:'Chapter 4', goalId:g1.id, when: dayKey+'T09:00', estimateHours:2, priority:3, status:'todo', remindAt:'', notes:'' },
                { id: uuid(), title: 'Integrals review', subject:'Past papers', goalId:g1.id, when: dayKey+'T14:00', estimateHours:1.5, priority:4, status:'doing', remindAt:'', notes:'' },
                { id: uuid(), title: 'Outline thesis', subject:'Draft structure', goalId:g2.id, when: dayKey+'T16:00', estimateHours:2, priority:2, status:'todo', remindAt:'', notes:'' }
            );
            saveData();
        }

        // ---------- RENDER ROOT ----------
        function render() {
            renderSidebarStats();
            renderGoals();
            renderFilters();
            renderCalendar();
            if (!selectedDate) selectedDate = formatDateKey(new Date());
            renderTasksForSelectedDay();
        }

        // Boot
        seedIfEmpty();
        rehydrateReminders();
        render();
    </script>
</body>
</html>

